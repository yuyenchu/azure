<!DOCTYPE html>
<html>
<head>
	<title>Welcome to nginx!</title>
	<script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/2.5.0/Chart.min.js"></script>
	<script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.5.1/jquery.min.js"></script>
	<script src="conn_worker.js"></script>
	<style>
		body {
				width: 45em;
				margin: 0 auto;
				font-family: Tahoma, Verdana, Arial, sans-serif;
		}
		p {
			text-indent: 50px;
		}
		.canvas {
			width: 100%;
			padding: 50px 0;
			text-align: center;
			background-color: lightblue;
			margin-top: 20px;
			line-height: 150%;
		}
		.inner {
				display: inline-block;
		}
	</style>
</head>
<body>
	<h1>Welcome to Andrew's Azure testing page!</h1>
	<h3>Registered Devices:</h3>
	<div id="devices"></div>
	<canvas id="myChart" width="400" height="400"></canvas>
	<script>
		// setInterval(function(){ 
		// 	var xhr = new XMLHttpRequest();
		// 	xhr.open("GET","/router/devices",false);
		// 	xhr.send(null);
		// 	var data = JSON.parse(xhr.responseText);
		// 	console.log(data);
		// 	console.log(items(data));
		// 	document.getElementById("devices").innerHTML = items(data);
		// }, 3000);

		function toggle(id) {
				var x = document.getElementById(id);
				if (x.style.display === "none") {
						x.style.display = "block";
				} else {
						x.style.display = "none";
				}
		}

		function items(data){
			var str ='' ;
			Object.keys(data).forEach(element =>{
				str +='<p>'+element+':  <span style="color:';
				if(data[element] == "Disconnected"){
					str += 'red">Disconnected</span>';
				} else {
					str += 'green">Connected</span>';
				}
				str += '</p><button onclick="toggle(\''+element+'\')">More Info</button><div id='+element+' class="canvas" style="display: none;">'
				str += twinInfo(element)+'</div>';
				});
			return str;
		}

		function twinInfo(id){
			var str ='';
			var twin_xhr = new XMLHttpRequest();
			twin_xhr.open("GET","/router/twin/"+id,false);
			twin_xhr.send(null);
			var twin = JSON.parse(JSON.parse(twin_xhr.responseText));
			Object.keys(twin).forEach(element =>{
				str += element+": "+JSON.stringify(twin[element])+"<br>";
			});
			return str;
		}

		var lineChart = new Chart(document.getElementById('myChart').getContext('2d'), {
			type: 'line',
			data: {	"labels": [],
							"datasets":[{	"label":"Temperature",
														"data":[],
														"fill":false,
														"borderColor":"rgb(255, 159, 0)",
														"lineTension":0.1},
													{	"label":"Humidity",
														"data":[],
														"fill":false,
														"borderColor":"rgb(0, 59, 174)",
														"lineTension":0.1},
													{	"label":"Power level",
														"data":[],
														"fill":false,
														"borderColor":"rgb(75, 192, 192)",
														"lineTension":0.1}
													]},
			options: {
            scales: {
                yAxes : [{
                    ticks : {
                        max : 100,    
                        min : 0
                    }
                }]
						},
						title: {
								display: true,
								text: 'Chart 1'
						}
        }
		});

		function drawChart(msg, title, bp){
				const dateTime = Date.now();
				const timestamp = Math.floor(dateTime / 1000);
				var brokerprop = JSON.parse(bp);
				console.log("bp"+bp);
				console.log("brokerprop"+brokerprop);
				var count = 0
				Object.keys(msg).forEach(element =>{
					lineChart.data.datasets[count].data.push(msg[element]);
					if(lineChart.data.datasets[count].data.length > 10){
						lineChart.data.datasets[count].data.shift();
					}
					count ++;
				});
				lineChart.data.labels.push(brokerprop["EnqueuedTimeUtc"]);
				if(lineChart.data.labels.length > 10){
					lineChart.data.labels.shift();
				}
				// lineChart.update({
				// 		duration: 800,
				// 		easing: 'easeOutBounce'
				// });
				lineChart.options.title.text = title;
				lineChart.update();
		}

		var doAjax = function() {
			$.ajax({
				url: "/router/queue",
				success: function (data, textStatus, request) {
					// console.log("data type: "+typeof(data));
					// console.log("data: "+data);
					var obj = JSON.parse(data);
					drawChart(obj.body,
										obj.header['iothub-connection-device-id'],
										obj.header['BrokerProperties']);
					
				},
				complete: function () {
					// Schedule the next
					setTimeout(doAjax, 1000);
				}
			});
		};

		var checkConn = function() {
			$.ajax({
				url: "/router/devices",
				success: function (data) {
					// console.log("data type: "+typeof(data));
					// console.log("data: "+data);
					// console.log("stringify data: "+JSON.stringify(data));
					document.getElementById("devices").innerHTML = items(JSON.parse(JSON.stringify(data)));
				},
				complete: function () {
					// Schedule the next
					setTimeout(doAjax, 1000);
				}
			});
		};

		// if(typeof(Worker) !== "undefined") {
		// 	var w = new Worker("conn_workers.js");
		// 	w.onmessage = function(event) {
		// 		console.log(event.data);
		// 		document.getElementById("devices").innerHTML = event.data;
		// 	};
		// } else {
		// 	document.getElementById("devices").innerHTML = "Sorry, your browser does not support Web Workers...";
		// }
		checkConn();
		// doAjax();
	</script>
</body>
</html>
